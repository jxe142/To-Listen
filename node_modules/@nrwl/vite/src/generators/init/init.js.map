{"version":3,"sources":["../../../../../../packages/vite/src/generators/init/init.ts"],"sourcesContent":["import {\n  addDependenciesToPackageJson,\n  convertNxGenerator,\n  readJson,\n  readWorkspaceConfiguration,\n  Tree,\n  updateJson,\n  updateWorkspaceConfiguration,\n} from '@nrwl/devkit';\n\nimport {\n  jsdomVersion,\n  nxVersion,\n  vitePluginDtsVersion,\n  vitePluginEslintVersion,\n  vitePluginReactVersion,\n  vitestUiVersion,\n  vitestVersion,\n  viteTsConfigPathsVersion,\n  viteVersion,\n} from '../../utils/versions';\nimport { Schema } from './schema';\n\nfunction checkDependenciesInstalled(host: Tree, schema: Schema) {\n  const packageJson = readJson(host, 'package.json');\n  const devDependencies = {};\n  const dependencies = {};\n  packageJson.dependencies = packageJson.dependencies || {};\n  packageJson.devDependencies = packageJson.devDependencies || {};\n\n  // base deps\n  devDependencies['@nrwl/vite'] = nxVersion;\n  devDependencies['vite'] = viteVersion;\n  devDependencies['vite-plugin-eslint'] = vitePluginEslintVersion;\n  devDependencies['vite-tsconfig-paths'] = viteTsConfigPathsVersion;\n  devDependencies['vitest'] = vitestVersion;\n  devDependencies['@vitest/ui'] = vitestUiVersion;\n  devDependencies['jsdom'] = jsdomVersion;\n\n  if (schema.uiFramework === 'react') {\n    devDependencies['@vitejs/plugin-react'] = vitePluginReactVersion;\n  }\n\n  if (schema.includeLib) {\n    devDependencies['vite-plugin-dts'] = vitePluginDtsVersion;\n  }\n\n  return addDependenciesToPackageJson(host, dependencies, devDependencies);\n}\n\nfunction moveToDevDependencies(tree: Tree) {\n  updateJson(tree, 'package.json', (packageJson) => {\n    packageJson.dependencies = packageJson.dependencies || {};\n    packageJson.devDependencies = packageJson.devDependencies || {};\n\n    if (packageJson.dependencies['@nrwl/vite']) {\n      packageJson.devDependencies['@nrwl/vite'] =\n        packageJson.dependencies['@nrwl/vite'];\n      delete packageJson.dependencies['@nrwl/vite'];\n    }\n    return packageJson;\n  });\n}\n\nexport function createVitestConfig(tree: Tree) {\n  const workspaceConfiguration = readWorkspaceConfiguration(tree);\n\n  const productionFileSet = workspaceConfiguration.namedInputs?.production;\n  if (productionFileSet) {\n    productionFileSet.push(\n      '!{projectRoot}/**/?(*.)+(spec|test).[jt]s?(x)?(.snap)',\n      '!{projectRoot}/tsconfig.spec.json'\n    );\n\n    workspaceConfiguration.namedInputs.production = Array.from(\n      new Set(productionFileSet)\n    );\n  }\n\n  workspaceConfiguration.targetDefaults ??= {};\n  workspaceConfiguration.targetDefaults.test ??= {};\n  workspaceConfiguration.targetDefaults.test.inputs ??= [\n    'default',\n    productionFileSet ? '^production' : '^default',\n  ];\n\n  updateWorkspaceConfiguration(tree, workspaceConfiguration);\n}\n\nexport function initGenerator(tree: Tree, schema: Schema) {\n  moveToDevDependencies(tree);\n  createVitestConfig(tree);\n  const installTask = checkDependenciesInstalled(tree, schema);\n  return installTask;\n}\n\nexport default initGenerator;\nexport const initSchematic = convertNxGenerator(initGenerator);\n"],"names":["createVitestConfig","initGenerator","initSchematic","workspaceConfiguration","checkDependenciesInstalled","host","schema","packageJson","readJson","devDependencies","dependencies","nxVersion","viteVersion","vitePluginEslintVersion","viteTsConfigPathsVersion","vitestVersion","vitestUiVersion","jsdomVersion","uiFramework","vitePluginReactVersion","includeLib","vitePluginDtsVersion","addDependenciesToPackageJson","moveToDevDependencies","tree","updateJson","readWorkspaceConfiguration","productionFileSet","namedInputs","production","push","Array","from","Set","targetDefaults","test","inputs","updateWorkspaceConfiguration","installTask","convertNxGenerator"],"mappings":"AAAA;;;;;;;;IAgEgBA,kBAAkB,MAAlBA;IAyBAC,aAAa,MAAbA;IAOhB,OAA6B,MAA7B;IACaC,aAAa,MAAbA;;wBAzFN;0BAYA;IA2DLC,yBACAA,iBACAA;AA1DF,SAASC,2BAA2BC,IAAU,EAAEC,MAAc,EAAE;IAC9D,MAAMC,cAAcC,IAAAA,gBAAQ,EAACH,MAAM;IACnC,MAAMI,kBAAkB,CAAC;IACzB,MAAMC,eAAe,CAAC;IACtBH,YAAYG,YAAY,GAAGH,YAAYG,YAAY,IAAI,CAAC;IACxDH,YAAYE,eAAe,GAAGF,YAAYE,eAAe,IAAI,CAAC;IAE9D,YAAY;IACZA,eAAe,CAAC,aAAa,GAAGE,mBAAS;IACzCF,eAAe,CAAC,OAAO,GAAGG,qBAAW;IACrCH,eAAe,CAAC,qBAAqB,GAAGI,iCAAuB;IAC/DJ,eAAe,CAAC,sBAAsB,GAAGK,kCAAwB;IACjEL,eAAe,CAAC,SAAS,GAAGM,uBAAa;IACzCN,eAAe,CAAC,aAAa,GAAGO,yBAAe;IAC/CP,eAAe,CAAC,QAAQ,GAAGQ,sBAAY;IAEvC,IAAIX,OAAOY,WAAW,KAAK,SAAS;QAClCT,eAAe,CAAC,uBAAuB,GAAGU,gCAAsB;IAClE,CAAC;IAED,IAAIb,OAAOc,UAAU,EAAE;QACrBX,eAAe,CAAC,kBAAkB,GAAGY,8BAAoB;IAC3D,CAAC;IAED,OAAOC,IAAAA,oCAA4B,EAACjB,MAAMK,cAAcD;AAC1D;AAEA,SAASc,sBAAsBC,IAAU,EAAE;IACzCC,IAAAA,kBAAU,EAACD,MAAM,gBAAgB,CAACjB,cAAgB;QAChDA,YAAYG,YAAY,GAAGH,YAAYG,YAAY,IAAI,CAAC;QACxDH,YAAYE,eAAe,GAAGF,YAAYE,eAAe,IAAI,CAAC;QAE9D,IAAIF,YAAYG,YAAY,CAAC,aAAa,EAAE;YAC1CH,YAAYE,eAAe,CAAC,aAAa,GACvCF,YAAYG,YAAY,CAAC,aAAa;YACxC,OAAOH,YAAYG,YAAY,CAAC,aAAa;QAC/C,CAAC;QACD,OAAOH;IACT;AACF;AAEO,SAASP,mBAAmBwB,IAAU,EAAE;QAGnBrB;IAF1B,MAAMA,yBAAyBuB,IAAAA,kCAA0B,EAACF;IAE1D,MAAMG,oBAAoBxB,CAAAA,MAAAA,uBAAuByB,WAAW,YAAlCzB,KAAAA,IAAAA,IAAoC0B,UAAU;IACxE,IAAIF,mBAAmB;QACrBA,kBAAkBG,IAAI,CACpB,yDACA;QAGF3B,uBAAuByB,WAAW,CAACC,UAAU,GAAGE,MAAMC,IAAI,CACxD,IAAIC,IAAIN;IAEZ,CAAC;;IAEDxB,qBAAAA,0BAAAA,wBAAuB+B,6CAAvB/B,wBAAuB+B,iBAAmB,CAAC,CAAC;;IAC5C/B,WAAAA,kBAAAA,uBAAuB+B,cAAc,EAACC,yBAAtChC,gBAAsCgC,OAAS,CAAC,CAAC;;IACjDhC,YAAAA,QAAAA,uBAAuB+B,cAAc,CAACC,IAAI,EAACC,4BAA3CjC,MAA2CiC,SAAW;QACpD;QACAT,oBAAoB,gBAAgB,UAAU;KAC/C;IAEDU,IAAAA,oCAA4B,EAACb,MAAMrB;AACrC;AAEO,SAASF,cAAcuB,IAAU,EAAElB,MAAc,EAAE;IACxDiB,sBAAsBC;IACtBxB,mBAAmBwB;IACnB,MAAMc,cAAclC,2BAA2BoB,MAAMlB;IACrD,OAAOgC;AACT;MAEA,WAAerC;AACR,MAAMC,gBAAgBqC,IAAAA,0BAAkB,EAACtC"}